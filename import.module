<?php


function import_system($field) {
  $system["description"] = t("The import module is a central place where all imported content comes together.");
  return $system[$field];
}


function import_perm() {
  return array("access import");
}

function import_link($type, $node = 0, $main = 0) {
  if ($type == "system" && user_access("access import")) {
    if (!module_exist("feed") || !module_exist("item")) {
      menu("import", t("news"), "import_page_error", 0);
    }
    else {
      menu("import", t("news"), "import_page_latest", 0);
      menu("import/sources", t("sources"), "import_page_sources", 0);
      if (module_exist("taxonomy_dhtml")) {
        menu("import/categories/item", t("categories"), "import_categories", 0);
        menu("import/categories/feed", t("sources by category"), "import_categories", 0);
      }
    }
  }

  return $links ? $links : array();
}

function import_page() {
  if (!module_exist("feed") || !module_exist("item")) {
    import_page_error();
  }
  else {
    if (arg(1) == "sources") {
      import_page_sources();
    }
    else if (arg(1) == "categories") {
      import_categories();
    }
    else {
      import_page_latest();
    }
  }
}

function import_theme_latestitem($node) {
  theme("node", $node, 0);
}

function import_page_latest() {
  theme("header", t("Latest news"));

  $nids = module_invoke_all("import", "items");
  if ($nids) {
    $result = pager_query("SELECT nid FROM {node} WHERE nid IN (". implode(",", $nids) .") ORDER BY created DESC, nid DESC", ($user->nodes ? $user->nodes : variable_get("default_nodes_main", 10)), 0); 
  }

  while ($import_node = db_fetch_object($result)) {
    theme("import_theme_latestitem", node_load(array("nid" => $import_node->nid)));
  }

  print pager_display("", ($user->nodes ? $user->nodes : variable_get("default_nodes_main", 10)), 0);

  theme("footer");
}

function import_categories() {
  $type = arg(2);
  if ($type != "item" && $type != "feed") {
    $type = "item";
  }
  $boxes = taxonomy_dhtml_overview($type);
  theme("header", ($type == "item" ? t("News by category") : t("News sources by category")));
  for ($n=0; $n < count($boxes); $n++) {
    theme("box", $boxes[$n]["subject"], $boxes[$n]["content"]);
  }
  theme("footer");
}

function import_theme_source($node) {
  theme("node", $node, 1);
}

function import_page_sources() {
  theme("header", t("News sources"));

  $nids = module_invoke_all("import", "sources");
  if ($nids) {
    $result = pager_query("SELECT nid FROM {node} WHERE nid IN (". implode(",", $nids) .") ORDER BY title, nid", ($user->nodes ? $user->nodes : variable_get("default_nodes_main", 10)), 0);
  }

  while ($import_source = db_fetch_object($result)) {
    theme("import_theme_source", node_load(array("nid" => $import_source->nid)));
  }

  print pager_display("", ($user->nodes ? $user->nodes : variable_get("default_nodes_main", 10)), 0);

  theme("footer");
}

function import_page_error() {
  theme("header");
  print theme("theme_error", t("For the import module to function properly please ensure that both the feed and item modules are enabled in the ". l(t("modules configuration"), "admin/system/modules") ." page."));
  theme("footer");
}
?>
